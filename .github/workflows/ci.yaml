---
name: Showcase tests
on:
  push:
    branches:
      - master
  pull_request:

jobs:
  regenerate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: '^1.13.1'
    - name: Checkout common protos
      run: git submodule init && git submodule update
    - name: Install protoc
      run: |
        mkdir protobuf
        curl -sSL https://github.com/protocolbuffers/protobuf/releases/download/v3.14.0/protoc-3.14.0-linux-x86_64.zip > protobuf/protoc.zip
        unzip -d protobuf protobuf/protoc.zip
        echo "./protobuf/bin" >> $GITHUB_PATH
    - name: Install external generators
      run: |
        go mod download
        go install github.com/golang/protobuf/protoc-gen-go
        go get github.com/googleapis/gapic-generator-go/cmd/protoc-gen-go_cli
        go get github.com/googleapis/gapic-generator-go/cmd/protoc-gen-go_gapic
    - name: Install REST server generator
      run: go install ./util/cmd/protoc-gen-go_rest_server
    - name: Regenerate sources
      run: go run ./util/cmd/compile_protos
    - uses: actions/upload-artifact@v2
      with:
        name: regenerated-sources
        path: |
          ./**/*.go
  tests:
    needs: regenerate
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: '^1.13.1'
    - uses: actions/download-artifact@v2
      with:
        name: regenerated-sources
    - name: Check for regenerated sources diff
      run: git ls-files --deleted --modified --other --directory --exclude-standard cmd client server/genproto server/genrest | grep / && echo "DIFF FOUND!"  || echo "No new generated files"
    - name: Run unit tests
      run: go test ./...
